---
title: '`r paste0("GSA well failure ", " /  ", params$gsa_names_full, "  /  ", params$decline_v_full)`'
output: 
  flexdashboard::flex_dashboard:
    vertical_layout: fill
    orientation: rows
    navbar:
      - { title: "Instructions",  align: right}
      - { title: "About", href: "https://www.gsawellfailure.com", align: right}
      - { icon: "fa-github", href: "https://www.github.com/richpauloo/aife", align: right}
    #css: /Users/richpauloo/Github/aife/jamstack/etc/w3.css
    #self_contained: false
    #lib_dir: libs
    #logo: etc/cwq_8_pixels.png
    #favicon: etc/cwq_8_pixels.png
params: 
  selected_gsa:     "hold"
  selected_decline: "hold"
  gsa_names_full:   "hold"
  decline_v_full:   "hold"
---

<!-- a wee bit of JS that allows a modal popup when the first -->
<!-- list element of the navbar (Instructions) is clicked -->
<!-- adapted from: https://github.com/rstudio/flexdashboard/issues/208 -->

<script>
  $('.navbar-brand').wrap('<a href="http://www.gsawellfailure.com">');
  
  <!-- modal popup when valueboxes are clicked -->
  $(document).ready(function() {
    $('#dashboard-container').on('flexdashboard:layoutcomplete', 
      function() {
        $('#navbar li:nth-child(1)').click(function() {
          $('#md-instructions').modal(); });
    })
  })
  
  $(document).ready(function() {
    $('#dashboard-container').on('flexdashboard:layoutcomplete', 
      function() {
        $('#groundwater-level-decline').click(function() {
          $('#md-groundwater-level-decline').modal(); });
    })
  })
  
  $(document).ready(function() {
    $('#dashboard-container').on('flexdashboard:layoutcomplete', 
      function() {
        $('#well-failures').click(function() {
          $('#md-well-failures').modal(); });
    })
  })
  
  $(document).ready(function() {
    $('#dashboard-container').on('flexdashboard:layoutcomplete', 
      function() {
        $('#percent-of-failing-wells').click(function() {
          $('#md-percent-of-failing-wells').modal(); });
    })
  })
  
  $(document).ready(function() {
    $('#dashboard-container').on('flexdashboard:layoutcomplete', 
      function() {
        $('#cost').click(function() {
          $('#md-cost').modal(); });
    })
  })
</script>

```{r setup, include=FALSE}
library(flexdashboard)
library(shiny)
library(bsplus)
library(leaflet)
library(htmltools)
library(htmlwidgets)
library(plotly)
library(stringr)
library(readr)
library(here)
library(leafem)

# read current groundwater level, mt surface, and gsas
gwl <- read_rds(here("code", "results", "gwl_2019_avg_ll.rds"))
mts <- read_rds(here("code", "results", "mt_surface_cv.rds"))
gsa <- read_rds(here("code", "results", "gsa_ll.rds"))

# store Rmd params as global variables
selected_gsa     <- "ALL"#params$selected_gsa #"tri_county_tule"
selected_gsa_url <- str_replace_all(selected_gsa, "_", "-")
selected_decline <- "mt"#params$selected_decline #"0"
selected_decline_ft <- ifelse(selected_decline != "mt",
                              paste0(selected_decline, " ft. of decline"),
                              "Minimum Threshold")

# read model output and filter to the correct gsa and decline
# d <- read_rds(here("code", "results", "model_results.rds")) %>% 
#   filter(gwl_decline == selected_decline & gsa == selected_gsa)

# read model output well data
# wells <- read_rds(here("code", "results", "well_results.rds")) %>% 
#   filter(gwl_decline == selected_decline & gsa == selected_gsa)

# value box data
if(selected_decline == "mt") { vb1 = "Min threshold" }
if(selected_decline != "mt") { vb1 = paste0(selected_decline, " ft.") }
# vb2 = filter(d, gwl_decline == selected_decline) %>% pull(n_fail)
# vb3 = filter(d, gwl_decline == selected_decline) %>% pull(p_fail)
# vb4 = filter(d, gwl_decline == selected_decline) %>% pull(cost)

# gsa names
gsa_names <- gsa@data$gsp_name %>% 
  tolower() %>% 
  str_remove_all("[\\(\\)]") %>% 
  str_remove_all(" dm") %>% 
  str_replace_all(" |-", "_") 

# filter gsa polygons to selected_gsa
if(selected_gsa != "ALL") {
  gsa <- gsa[which(gsa_names == selected_gsa), ]
}

# utility functions
source(here("jamstack", "etc", "functions.R"))
  
# root url for links
root <- "https://www.gsawellfailure.com/gsas/"
```

Row {.sidebar data-width=150 data-padding=10}
-----------------------------------------------------------------------


```{r sidebar downdown menus}
# GSA dropdown
tags$div(
  class="dropdown",
  tags$button(
    class="dropbtn", "GSA"),
  tags$div(
    class = "dropdown-content",
    tags$a(href = paste0(root, "ALL/", selected_decline), "ALL"),
    tags$a(href = paste0(root, "northern-central/", selected_decline), "Northern Central (DM)"),
    tags$a(href = paste0(root, "farmers/", selected_decline), "Farmers (DM)"),
    tags$a(href = paste0(root, "east-kaweah/", selected_decline), "East Kaweah"),
    tags$a(href = paste0(root, "chowchilla/", selected_decline), "Chowchilla"),
    tags$a(href = paste0(root, "madera-joint/", selected_decline), "Madera Joint"),
    tags$a(href = paste0(root, "central-kings/", selected_decline), "Central Kings"),
    tags$a(href = paste0(root, "north-fork-kings/", selected_decline), "North Fork Kings"),
    tags$a(href = paste0(root, "south-kings/", selected_decline), "South Kings"),
    tags$a(href = paste0(root, "mc-mullin/", selected_decline), "Mc Mullin"),
    tags$a(href = paste0(root, "gravelly-ford-madera/", selected_decline), "Gravelly Ford (Madera)"),
    tags$a(href = paste0(root, "pixley-tule/", selected_decline), "Pixley (Tule)"),
    tags$a(href = paste0(root, "westside/", selected_decline), "Westside"),
    tags$a(href = paste0(root, "greater-kaweah/", selected_decline), "Greater Kaweah"),
    tags$a(href = paste0(root, "new-stone-madera/", selected_decline), "New Stone (Madera)"),
    tags$a(href = paste0(root, "mid-kaweah/", selected_decline), "Mid Kaweah"),
    tags$a(href = paste0(root, "aliso/", selected_decline), "Aliso (DM)"),
    tags$a(href = paste0(root, "merced/", selected_decline), "Merced"),
    tags$a(href = paste0(root, "kings-river-east/", selected_decline), "Kings River East"),
    tags$a(href = paste0(root, "north-kings/", selected_decline), "North Kings"),
    tags$a(href = paste0(root, "henry-miller-kern/", selected_decline), "Henry Miller (Kern)"),
    tags$a(href = paste0(root, "grassland/", selected_decline), "Grassland (DM)"),
    tags$a(href = paste0(root, "tulare-lake/", selected_decline), "Tulare Lake"),
    tags$a(href = paste0(root, "east-tule/", selected_decline), "East Tule"),
    tags$a(href = paste0(root, "olcese-kern/", selected_decline), "Olcese (Kern)"),
    tags$a(href = paste0(root, "root-creek-madera/", selected_decline), "Root Creek (Madera)"),
    tags$a(href = paste0(root, "buena-vista-kern/", selected_decline), "Buena Vista (Kern)"),
    tags$a(href = paste0(root, "kern-river/", selected_decline), "Kern River"),
    tags$a(href = paste0(root, "delano-earlimart-tule/", selected_decline), "Delano-Earlimart (Tule)"),
    tags$a(href = paste0(root, "sjrec/", selected_decline), "SJREC (DM)"),
    tags$a(href = paste0(root, "fresno-county/", selected_decline), "Fresno County (DM)"),
    tags$a(href = paste0(root, "james-kings/", selected_decline), "James (Kings)"),
    tags$a(href = paste0(root, "kern-groundwater-authority/", selected_decline), "Kern Groundwater Authority"),
    tags$a(href = paste0(root, "eastern-san-joaquin/", selected_decline), "Eastern San Joaquin"),
    tags$a(href = paste0(root, "alpaugh-tule/", selected_decline), "Alpaugh (Tule)"),
    tags$a(href = paste0(root, "lower-tule-river/", selected_decline), "Lower Tule River"),
    tags$a(href = paste0(root, "tri-county-tule/", selected_decline), "Tri-County (Tule)")
    )
)

tags$br()
tags$br()

# groundwater level dropdown
tags$div(
  class="dropdown",
  tags$button(
    class="dropbtn", paste0("Groundwater scenario")),
  tags$div(
    class = "dropdown-content",
    tags$a(href = paste0(root, selected_gsa_url, "/", "mt"),  "Minimum Threshold"),
    tags$a(href = paste0(root, selected_gsa_url, "/", "0"),   "0 ft decline"),
    tags$a(href = paste0(root, selected_gsa_url, "/", "10"),  "10 ft decline"),
    tags$a(href = paste0(root, selected_gsa_url, "/", "20"),  "20 ft decline"),
    tags$a(href = paste0(root, selected_gsa_url, "/", "30"),  "30 ft decline"),
    tags$a(href = paste0(root, selected_gsa_url, "/", "40"),  "40 ft decline"),
    tags$a(href = paste0(root, selected_gsa_url, "/", "50"),  "50 ft decline"),
    tags$a(href = paste0(root, selected_gsa_url, "/", "100"), "100 ft decline"),
    tags$a(href = paste0(root, selected_gsa_url, "/", "150"), "150 ft decline"),
    tags$a(href = paste0(root, selected_gsa_url, "/", "200"), "200 ft decline"),
    tags$a(href = paste0(root, selected_gsa_url, "/", "250"), "250 ft decline"),
    tags$a(href = paste0(root, selected_gsa_url, "/", "300"), "300 ft decline"),
    tags$a(href = paste0(root, selected_gsa_url, "/", "400"), "400 ft decline"),
    tags$a(href = paste0(root, selected_gsa_url, "/", "500"), "500 ft decline")
    )
)
```


<!-- Row {data-width=100} -->
Row
-----------------------------------------------------------------------

```{r}
# markdown files for methods behind each of the reported statistics, obtained when clicking value boxes
bs_modal(
  id = "md-instructions",
  title = "Using Markdown",
  body = includeMarkdown(system.file("markdown","modal.md",package="bsplus"))
)
bs_modal(
  id = "md-groundwater-level-decline",
  title = "Using Markdown",
  body = includeMarkdown(system.file("markdown","modal.md",package="bsplus"))
)
bs_modal(
  id = "md-well-failures",
  title = "Using Markdown",
  body = includeMarkdown(system.file("markdown","modal.md",package="bsplus"))
)
bs_modal(
  id = "md-percent-of-failing-wells",
  title = "Using Markdown",
  body = includeMarkdown(system.file("markdown","modal.md",package="bsplus"))
)
bs_modal(
  id = "md-cost",
  title = "Using Markdown",
  body = includeMarkdown(system.file("markdown","modal.md",package="bsplus"))
)
```

```{r, include=FALSE}
# continuation of the above
bs_button("Click for modal", button_type = "primary") %>%
  bs_attach_modal("md-instructions")
bs_button("Click for modal", button_type = "primary") %>%
  bs_attach_modal("md-groundwater-level-decline")
bs_button("Click for modal", button_type = "primary") %>%
  bs_attach_modal("md-well-failures")
bs_button("Click for modal", button_type = "primary") %>%
  bs_attach_modal("md-percent-of-failing-wells")
bs_button("Click for modal", button_type = "primary") %>%
  bs_attach_modal("md-cost")
```


### Groundwater level decline
```{r}
valueBox(vb1,
         color = "primary",
         icon = "ion-arrow-down-a")
```

### Well failures
```{r}
valueBox("5000-10000", #vb2,
         color = "danger", 
         icon = "fa-times-circle")
```

### Percent of failing wells
```{r}
valueBox("15-60", #vb2,
         color = "warning", 
         icon = "fa-percent")
```

### Cost
```{r}
valueBox("$1.2-1.3M", #vb2,
         color = "success", 
         icon = "ion-cash")
```



Row
-----------------------------------------------------------------------

### `r ifelse(selected_gsa != "mt", paste0(gsa@data$gsp_name, " GSA and groundwater levels"), "All critical priority GSAs and groundwater levels")`
```{r, leaflet}
# color palettes for gwl decline
col <- rev(colormap::colormap(colormap::colormaps$magma, nshades = 100))
# hack the color pal to include values in both scales (use -10)
pal <- colorNumeric(col, c(-10,raster::values(mts)), na.color = "transparent")

# read all plotly plots in
if(selected_gsa == "ALL") {
  l <- vector("list", length(gsa_names))
  for(i in 1:length(gsa_names)){
    l[[i]] <- 
      read_rds(
        paste0("~/Github/aife/plotly/",
               selected_decline,"_", gsa_names[i], ".rds"
        )
      ) %>% 
      as.tags() %>%
      {tags$div(style="width:270px; height:220px;", .)} %>%
      as.character() %>% 
      stringr::str_replace("height:400px","height:100%")
    l[[i]] <- 
      paste0("<em><b>", 
             tags$a(gsa@data$gsp_name[i], 
                    href = 
                      paste0(root, 
                             str_replace_all(gsa_names[i],"_","-"),
                                             "/", selected_decline)
                    ),
             "</b></em><br>",
             "N-M wells fail at ", selected_decline_ft ,"<br>",
             "$X-Y estimated cost<br>",
             l[[i]]
      )
  }
}

if(selected_gsa != "ALL") { l <- NULL}

# setZoom parameters
xy        <- sp::bbox(gsa) %>% apply(1, mean)
names(xy) <- NULL
xy        <- xy + c(0.4, 0.2)
zoom      <- ifelse(selected_gsa == "ALL", 7, 8)

# map 
leaflet() %>% 
  
  # tiles
  addProviderTiles("CartoDB") %>% 
  
  # groundwater level
  addRasterImage(gwl, opacity = 0.8, colors = pal, 
                 layerId = "2019", group = "2019 groundwater level") %>%
  addRasterImage(mts, opacity = 0.8, colors = pal, 
                 layerId = "2040", group = "2040 min threshold") %>%

  addLegend(pal = pal, values = raster::values(mts),
            title    = "Groundwater <br>level (ft. BLS)",
            position = "bottomright") %>%
  
  # layer control
  addLayersControl(
    overlayGroups = c("critical priority GSAs"),
    baseGroups    = c("2019 groundwater level", "2040 min threshold"),
    options       = layersControlOptions(collapsed = FALSE,
                                         position = "bottomleft")
  ) %>%
  
  # center
  # setView(-119.7, 36.8, 7) %>% 
  setView(xy[1], xy[2], zoom) %>% 
  
  # zoom to center
  addEasyButton(easyButton(
    icon="fa-globe", title="Zoom to center",
    onClick=JS(
      paste0("function(btn, map){ map.setView([",
             #"36.8, -119.7], 7)",
             xy[2], ",", xy[1], "],", zoom, ")",
             "; }")
      ),
    position = "topleft")
  ) %>% 
  
  # full screen
  leaflet.extras::addFullscreenControl(position = "topleft") %>% 

  # polygons
  addPolygons(data = gsa, weight = 1, opacity = 1, fillOpacity = 0.1,
              group = "critical priority GSAs",
              label = ~gsp_name, 
              highlightOptions = 
                highlightOptions(color = "black", weight = 2,
                                 bringToFront = TRUE),
              labelOptions = labelOptions(textsize = "13px"),
              popup = l
  ) %>% 
  
  # raster value display
  leafem::addMouseCoordinates() %>%
  leafem::addImageQuery(gwl, type="mousemove", layerId = "2019",
                        group = "2019 groundwater level", prefix = "",
                        digits = 2, position = "bottomright") %>%
  leafem::addImageQuery(mts, type="mousemove", layerId = "2040",
                        group = "2040 min threshold", prefix = "",
                        digits = 2, position = "bottomright") %>%
  
  # JS for polygon popups
  onRender(
    "function(el,x) {
    this.on('popupopen', function() {HTMLWidgets.staticRender(); remove()})
    }"
  ) %>%
  add_deps("plotly") %>%
  htmltools::attachDependencies(plotly:::plotlyMainBundle(), append = TRUE) %>%
  htmltools::attachDependencies(crosstalk::crosstalkLibs(),  append = TRUE) %>%
  browsable()
```

### `r ifelse(selected_gsa != "ALL", paste0("Forecasted well failure rates for ", gsa@data$gsp_name), "Forecasted well failure rates for all critical priority GSAs")`
```{r, plot}
readr::read_rds(paste0("../plotly/", selected_decline, "_", selected_gsa, ".rds"))
```



